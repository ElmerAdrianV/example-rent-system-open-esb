<?xml version="1.0" encoding="UTF-8" ?>
<process
    name="carRentalFi"
    targetNamespace="http://enterprise.netbeans.org/bpel/CarRentalFi/carRentalFi"
    xmlns:tns="http://enterprise.netbeans.org/bpel/CarRentalFi/carRentalFi"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:ns0="http://xml.netbeans.org/schema/CarRentalFiSchema">
    <import namespace="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" location="myCarRentalFi.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/WS_ReservationWrapper" location="WS_ReservationWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://wsreservation/" location="http://localhost:8080/WS_Reservations/WS_Reservation?WSDL" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://enterprise.netbeans.org/bpel/WS_customer_vehiclesWrapper" location="WS_customer_vehiclesWrapper.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://ws_customer_vehicles/" location="http://localhost:8080/WS_Customer_Vehicle/WS_customer_vehicles?WSDL" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <partnerLinks>
        <partnerLink name="Customers_Vehicles" xmlns:tns="http://enterprise.netbeans.org/bpel/WS_customer_vehiclesWrapper" partnerLinkType="tns:WS_customer_vehiclesLinkType" partnerRole="WS_customer_vehiclesRole"/>
        <partnerLink name="Reservation" xmlns:tns="http://enterprise.netbeans.org/bpel/WS_ReservationWrapper" partnerLinkType="tns:WS_ReservationLinkType" partnerRole="WS_ReservationRole"/>
        <partnerLink name="PartnerLink1" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" partnerLinkType="tns:myCarRentalFi" myRole="myCarRentalFiPortTypeRole"/>
    </partnerLinks>
    <variables>
        <variable name="ReservationErrorOut" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" messageType="tns:ReservationFault"/>
        <variable name="ReservationOut" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" messageType="tns:ReservationResponse"/>
        <variable name="ReservationRequestOut" xmlns:tns="http://wsreservation/" messageType="tns:ReservationRequestResponse"/>
        <variable name="ReservationRequestIn" xmlns:tns="http://wsreservation/" messageType="tns:ReservationRequest"/>
        <variable name="Fault1FaultVar" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" messageType="tns:ReservationFault"/>
        <variable name="CustomerExistanceOut" xmlns:tns="http://ws_customer_vehicles/" messageType="tns:CustomerExistanceResponse"/>
        <variable name="CustomerExistanceIn" xmlns:tns="http://ws_customer_vehicles/" messageType="tns:CustomerExistance"/>
        <variable name="VehicleExistanceOut" xmlns:tns="http://ws_customer_vehicles/" messageType="tns:VehicleExistanceResponse"/>
        <variable name="VehicleExistanceIn" xmlns:tns="http://ws_customer_vehicles/" messageType="tns:VehicleExistance"/>
        <variable name="ValidationRequest" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" messageType="tns:ReservationRequest"/>
    </variables>
    <sequence>
        <receive name="Receive1" createInstance="yes" 
                 partnerLink="PartnerLink1" 
                 operation="Reservation" 
                 xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" 
                 portType="tns:myCarRentalFiPortType" 
                 variable="ValidationRequest"/>
        <assign name="Assign1">
            <copy>
                    <from>$ValidationRequest.InitialValidationRequest/idCustomer</from>
                        <to>$CustomerExistanceIn.parameters/arg0</to>
                </copy>
                <copy>
                    <from>$ValidationRequest.InitialValidationRequest/idVehicle</from>
                        <to>$VehicleExistanceIn.parameters/arg0</to>
                </copy>
        </assign>
        <scope name="Scope1">
            <faultHandlers>
                <catch>
                    <sequence name="Sequence5">
                        <assign name="Assign2">
                            <copy>
                                    <from>'Existence error'</from>
                                        <to>$Fault1FaultVar.Error/ns0:faultDetail</to>
                                </copy>
                        </assign>
                        <reply name="Reply1" partnerLink="PartnerLink1" operation="Reservation" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" portType="tns:myCarRentalFiPortType" faultName="tns:fault1" variable="Fault1FaultVar"/>
                    </sequence>
                </catch>
            </faultHandlers>
            <sequence name="Sequence7">
                <invoke name="Invoke1" partnerLink="Customers_Vehicles" operation="VehicleExistance" xmlns:tns="http://ws_customer_vehicles/" portType="tns:WS_customer_vehicles" inputVariable="VehicleExistanceIn" outputVariable="VehicleExistanceOut"/>
                <invoke name="Invoke2" partnerLink="Customers_Vehicles" operation="CustomerExistance" xmlns:tns="http://ws_customer_vehicles/" portType="tns:WS_customer_vehicles" inputVariable="CustomerExistanceIn" outputVariable="CustomerExistanceOut"/>
            </sequence>
        </scope>
        <assign name="Assign3">
            <copy>
                    <from>$ValidationRequest.InitialValidationRequest/ns0:idCustomer</from>
                        <to>$ReservationRequestIn.parameters/customer_id</to>
                </copy>
                <copy>
                    <from>$ValidationRequest.InitialValidationRequest/ns0:idVehicle</from>
                        <to>$ReservationRequestIn.parameters/vehicle_id</to>
                </copy>
                <copy>
                    <from>$ValidationRequest.InitialReservationDetails/ns0:startDate</from>
                        <to>$ReservationRequestIn.parameters/start_date</to>
                </copy>
                <copy>
                    <from>$ValidationRequest.InitialReservationDetails/ns0:finishDate</from>
                        <to>$ReservationRequestIn.parameters/end_date</to>
                </copy>
                <copy>
                    <from>$ValidationRequest.InitialReservationDetails/ns0:TdaId</from>
                        <to>$ReservationRequestIn.parameters/id_Tda</to>
                </copy>
                <copy>
                    <from>$ValidationRequest.InitialReservationDetails/ns0:report</from>
                        <to>$ReservationRequestIn.parameters/report</to>
                </copy>
        </assign>
        <scope name="Scope2">
            <variables>
                <variable name="Fault1FaultVar1" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" messageType="tns:ReservationFault"/>
            </variables>
            <faultHandlers>
                <catch>
                    <sequence name="Sequence6">
                        <assign name="Assign6">
                            <copy>
                                <from>'IllegalArgumentException'</from>
                                <to>$Fault1FaultVar1.Error/ns0:faultDetail</to>
                            </copy>
                        </assign>
                        <reply name="Reply4" partnerLink="PartnerLink1" operation="Reservation" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" portType="tns:myCarRentalFiPortType" faultName="tns:fault1" variable="Fault1FaultVar1"/>
                    </sequence>
                </catch>
            </faultHandlers>
            <invoke name="Invoke3" partnerLink="Reservation" operation="ReservationRequest" xmlns:tns="http://wsreservation/" portType="tns:WS_Reservation" inputVariable="ReservationRequestIn" outputVariable="ReservationRequestOut"/>
        </scope>
        <if name="If2" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi">
            <condition>$ReservationRequestOut.parameters/return</condition>
                <sequence name="Sequence3">
                    <assign name="Assign4">
                            <copy>
                                <from>'The reservation was made successfully'</from>
                                <to>$ReservationOut.FinalMessage/ns0:Authorization</to>
                            </copy>
                        </assign>
                        <reply name="Reply2" partnerLink="PartnerLink1" operation="Reservation" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" portType="tns:myCarRentalFiPortType" variable="ReservationOut"/>
                </sequence>
                <else>
                    <sequence name="Sequence4">
                            <assign name="Assign5">
                                <copy>
                                    <from>'Error making reservation'</from>
                                    <to>$ReservationErrorOut.Error/ns0:faultDetail</to>
                                </copy>
                            </assign>
                                <reply name="Reply3" partnerLink="PartnerLink1" operation="Reservation" xmlns:tns="http://j2ee.netbeans.org/wsdl/CarRentalFi/src/myCarRentalFi" portType="tns:myCarRentalFiPortType" faultName="tns:fault1" variable="ReservationErrorOut"/>
                        </sequence>
                </else>
        </if>
    </sequence>
</process>
